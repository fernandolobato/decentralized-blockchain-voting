loadScript('/Users/fernandolobato/Desktop/tesina/blockchain_voting/deploy/deploy.js');

//loadScript('/Users/fernandolobato/Desktop/tesina/blockchain_voting/tests/test_registerVoter.js');

var numVoterPerRing = 10;
var registrationStartTime = eth.getBlock(eth.blockNumber).timestamp + (60 * 5);
var registrationEndTime = registrationStartTime + (60 * 10);
var registrationVotingGap = (60 * 10);
var votingStartTime = registrationEndTime + registrationVotingGap;
var votingEndTime = votingStartTime + (60 * 10);
var thresholdKey = [new BigNumber('90707198880225589485528336504749167732206651384440532747977047495411092046340'), new BigNumber('77084686888007402684172433506500060614310963628784863865537207333428118762045')];
var secretShareVerifyPublicParams = [[new BigNumber('90707198880225589485528336504749167732206651384440532747977047495411092046340'), new BigNumber('77084686888007402684172433506500060614310963628784863865537207333428118762045')],[new BigNumber('49350005808383302783042045427704947485544722476824293903450283537989159942450'), new BigNumber('90108999286733602337371949814062733273551140570796147712088604473945890851861')],[new BigNumber('64339514700532449445185865156921574028463049708070436070900564526691351119767'), new BigNumber('26158242204126733289338399713561943963149172697945046488891245334023385597880')],[new BigNumber('58902117177447791115821116144889288190100789255069829584719574514399215991577'), new BigNumber('20289824429026413922144544816472085423183208637154748624463959312121668442941')],[new BigNumber('105017402916506244200490181456334332313176026815639637721625193522493368665828'), new BigNumber('7961995489715701823898250278072888891793398145248077940672200395381755806101')],[new BigNumber('33804538464200777412681467085190814485545172357595015290431676178288082772180'), new BigNumber('104108737397705816236270176988569207945307324676913114702351976851153051956532')],[new BigNumber('104577946860589706899769219675820042681268801449041759597884768012039533345581'), new BigNumber('59507489266175605398457522727785180031610942465344835354674122188699674146582')],[new BigNumber('7893626809082308123054331426479839645471592744985363512465459223889838147396'), new BigNumber('7618630237953768918491256097089925269516803227910825566337876250768439736475')],[new BigNumber('88615539394742769173526331498704337847300014777132898371183736363007263005927'), new BigNumber('91436632728213246267575217039600247758814574357058693804490587593952838216981')],[new BigNumber('47613066797889855795182695765873577419680073619907936513971097498002506152977'), new BigNumber('7188155867287692306159154692068164186742420749317223739373299333559113076583')]];


var pubKeys = [[new BigNumber('39134665287266145223821378754996003869962064721102074457258140471885685830153'),new BigNumber('5898136820199176836044335807130369366235165719272657572059415027580551325610')],[new BigNumber('71505288987697536618010917879111718176677252701790242528148201043705511315227'),new BigNumber('55517716380981264240109491224096051529415711484131650070818851426354550715693')],[new BigNumber('51947058710702098802375073507772437595756361967480092849734032524314877394236'),new BigNumber('32794437860428447161139893525657269425770431644848433986180278743126953619484')],[new BigNumber('49241441010949182081604687968427929484720263876302048451683226090448678931336'),new BigNumber('85753428740437484252174143901324949444033263939280477633998288469125388314287')],[new BigNumber('112032079881162174677792841583399377265012961191446164378335074724857842881174'),new BigNumber('54070825621076500136090187648910002946891036779375864018913185034602876714632')],[new BigNumber('38688250581161275134951493772284082265375669113951714642110098475985337189579'),new BigNumber('47290067099186019330547699825081170150665043423765608305657346940457301112266')],[new BigNumber('58704197173256116257638451635659025088906385294416941295654110240025533966828'),new BigNumber('54864587587165022524626252505567905967877291195679089216040253268036130312155')],[new BigNumber('48538370376865374313015924636094916964928902338386291749769364514499974892815'),new BigNumber('91649652221678741243868714808272377003188453806320877012670174198854611234374')],[new BigNumber('81624560874411048098368805579391737206275007452535991070152780817135147638781'),new BigNumber('78788710865935252749137610013168388483441639514696100738253151726647082839358')],[new BigNumber('27321429391113506639037171652997607541019512188755480705179887869753095241923'),new BigNumber('4549219621936102658545144601773880266585147618693824278898867936414537977006')],[new BigNumber('27949056988100756353281756183877658418812216706390161154349589156115164538086'),new BigNumber('60503903975738082522940918693293630861670907944948810013816832686749099606443')],[new BigNumber('7214332655044179921335842688169707331058789756583194117791510549595620724895'),new BigNumber('3914242007845470596843001328086125938102832744324367065908434763513544154462')],[new BigNumber('51518922010839691836488338725956760879685230230507733090948339896112129127477'),new BigNumber('58188694766612259315441883668495096929856009205568169007905645103783295775599')],[new BigNumber('101751525222011914444434071232574739661584142345131606833051113183090487591118'),new BigNumber('100122693646232185712608878414973246928285072411207853228442820352732847571900')],[new BigNumber('62624283495934771689267601344834709113256064221100104441848410586404635043549'),new BigNumber('88890482715390720464609876174022762350063681815615602844082928733124860838705')],[new BigNumber('54115092171966528842462839962489108442395357438613863430731865494021790094624'),new BigNumber('101009537362857341364592022547790532705825847721185206914207647930394647953558')],[new BigNumber('35661536329979245631687460268567550122558031320468199007629388780010983322539'),new BigNumber('79128273369003990809916672906974180597321638511232368344936837317691270885625')],[new BigNumber('103715098892262306866846794165316884755696946606355733628291468721747460991577'),new BigNumber('97957958895764046161872695045506274658263010686500808036119239619743691857952')],[new BigNumber('90676949734430696383492293354739856668669887286350384101971306471412950860108'),new BigNumber('64747716981046870702327458033893063617861121840185876127253116475926393988447')],[new BigNumber('100760286634983440014736812972971191365477278769003607140211916552257471849983'),new BigNumber('1440462765706101308061689334941223979156248529668028763933762270616242980764')],[new BigNumber('103616261663764013606977080040506357026929636076726806394380402035695103127300'),new BigNumber('110135329750763754937162216239392300907909587793920796338085565108308989841778')],[new BigNumber('4287542278803842916460368222189901089258639708295225329497580589974868308763'),new BigNumber('108730260765449277100224826692649640908700965877535474695806426060174370377411')],[new BigNumber('13836414378662792145218240151026283130865462947459091506908748503410950740366'),new BigNumber('25236663153034081052923685989445030051574651588485273463298873849305535097678')],[new BigNumber('45244869969603056342781680664746441386349738999429978667941700968856059790682'),new BigNumber('38148810757886767689041458455241821471353548488854667071000366230881724433027')],[new BigNumber('68954101776281180862199064526940730716111405171318514550231414129193426880185'),new BigNumber('44975114316829836104764539336028990439722853469824859781538562152083565077721')],[new BigNumber('20650713201802742429907477069060914946471924537581972383392500971594426610276'),new BigNumber('55337521683680910670881605103709737243719612054247826546521757607634041100203')],[new BigNumber('90609236077317744161451881966260690931954809358330950967073872769482856284400'),new BigNumber('112422354825782136335083982128529198928345767069306968662407203283510185785315')],[new BigNumber('45579192665321925648629503264757823598672593065605191593750638051416051202076'),new BigNumber('73220239174290811237829985326277228075697214580061353951126727728315845279074')],[new BigNumber('26552185421767817363847586381751226914415549424874242378018163302224166350771'),new BigNumber('23756634192016007000470161446430382362734698085261619325636915875979294789670')],[new BigNumber('78147549453666593512111133227224144195866673604757729676860511910073001481890'),new BigNumber('53827737106816830558629099803016822104047135068463183337697575142227044058599')],[new BigNumber('13227301714959299075957862250347928144272044865095337701673110660745983185502'),new BigNumber('107201090293469672052035750805636502179289549739363986950006728766026232442829')],[new BigNumber('78050219267567482920327139180033226835472829664716425119094056727080232043009'),new BigNumber('21207447262415022808289329920593403212915701136597980234534171644605599701746')],[new BigNumber('18943328270574905809458248196487817692618170321751074519169379546660343022362'),new BigNumber('34477372501519211231509564473503050194201033004931626240219884808855304793047')],[new BigNumber('73614940395677917515172762916193187336141901597266276509196876229537678011056'),new BigNumber('4382281528302594536234629115200411068482768012595205538132743350420432001406')],[new BigNumber('73950458689261956809846227819302119509751367427133218171615209182374112235836'),new BigNumber('83832822686657696755625394117377476045050975388123627035050795566077194238934')],[new BigNumber('3474561361469212526747111995946041351237956498655275521748340573774843668036'),new BigNumber('86261787225629507637996654146378371848524082939895764902722533175987088830578')],[new BigNumber('7180271220619383398869362783400742157153936763792779221978281949106587108356'),new BigNumber('94077079034633687934704056477339120055059946098147294325084569114978505646382')],[new BigNumber('47419288768590634883110274313856223076084372773128853777248451554984385092872'),new BigNumber('78017896837185101573355775902672774508405430549779074350944061213659618885267')],[new BigNumber('37451955933324586074288274852132568893930852131529565689445649102451897322248'),new BigNumber('14551088099803650912924014227520683598591723175774868249203663349496762880796')],[new BigNumber('66274646246727934322751605053917684765500887881465939650060260926167499451297'),new BigNumber('5951556144782847572262216920813285745331741829000195858608248125712639227652')],[new BigNumber('37478904765227399904672867007964256723941816589156653508515050071840097956752'),new BigNumber('64919593515001867545443321572704872203285681085515992259901303464311264429510')],[new BigNumber('36694817210020259492949319938239046528394674504316545710382660124877790455409'),new BigNumber('26768251633018951942178895991829708277838809451540154698400173529601868840693')],[new BigNumber('45015213336190891797684946255394841440183722411098427153541373303631592587217'),new BigNumber('5502582811291814145852541101893071148398289327588467850995956657549496427809')],[new BigNumber('28394857108466854050758150174109826764455287825388946386978326803199232351456'),new BigNumber('54349966383750733245699666742179895922904035830072071935778312342336981894022')],[new BigNumber('618145892095058324702265391515449101591804579740306456540993772210476573424'),new BigNumber('897574421406350942851848658675679402075058667038949608660218580558964752422')],[new BigNumber('34524136395057754311645678848398453440020967104528412046709435267022841820302'),new BigNumber('8739320447581404369123851243985481612230891986058784877068016993565997934190')],[new BigNumber('13247186617003129217628654966347487185941005477292848916598854315014959442452'),new BigNumber('80196234981806635080250404863187597000168171615172460054961977542636175986752')],[new BigNumber('111956848207639705499363907695975441353165373720661647549778020678265119244227'),new BigNumber('58912485716344004275539423464439687440153448744447097296922848609892742610224')],[new BigNumber('4178115455732589285529859838197395948513595125309980285254440953719001677833'),new BigNumber('92818407772410183811046087698274978720570450355192922718716285237344545238424')],[new BigNumber('74235823442787082098126417878249422031699720972397234423420659810219087317563'),new BigNumber('11455578909924274857474774851832980404787754461014718335518986621071403483588')]];

function testRegiserVoters(e, contract) {

    //First we must move election to registration phase.
    var transactionHash = contract.finishSetUp.sendTransaction(
        numVoterPerRing,
        registrationStartTime,
        registrationEndTime,
        registrationVotingGap,
        votingStartTime,
        votingEndTime,
        secretShareVerifyPublicParams,
        thresholdKey,
        {from:eth.accounts[0], gas:4200000});
    

    var transaction = eth.getTransaction(transactionHash);

    while(transaction == null || transaction.blockNumber == null) {
        var transaction = eth.getTransaction(transactionHash);
    }
    
    assert(contract.state.call() == 1, 'Contract did not change state.');
    
    if(contract.state.call() != 1 ){
        return;
    }

    // Election registration phase started.

    // Secondly we must register all voters.
    var numRegisteredVoters = 0;

    // Should change to pubKeys.length (Test will take longer).
    var numVotersToRegister = 21

    for(var i = 0; i < numVotersToRegister; i++) {
        var txHash = contract.registerVoter.sendTransaction(pubKeys[i], {from:eth.accounts[0], gas:4200000});

        var tx = eth.getTransaction(txHash);

        while(tx == null || tx.blockNumber == null) {
            var tx = eth.getTransaction(txHash);
        }
        numRegisteredVoters += 1;
        //console.log(numRegisteredVoters);
        assert(contract.getNumRegisterVoters.call(), numRegisteredVoters);
    }

    //Verify all the ring stuff.
    var numRings =  Math.floor(numRegisteredVoters / numVoterPerRing);
    var count = 0;

    // Make sure all the registered keys are on the blockchain in the ring they should be.
    for(var i = 0; i < numRings; i++) {
        for(var j = 0; j < numVoterPerRing; j++) {

            var x = contract.ring.call(i, j*2);
            var y = contract.ring.call(i, (j*2) + 1);

            assert(x.toString() == pubKeys[count][0].toString(), 'Public keys should match');
            assert(y.toString() == pubKeys[count][1].toString(), 'Public keys should match');

            assert(x.toString() == contract.voters(count, 0).toString());
            assert(y.toString() == contract.voters(count, 1).toString());

            count += 1;
        }
    }
    
    // Check the voters in the last not filled ring.
    if( numRings * numVoterPerRing < numVotersToRegister ) {
        var offset = numVotersToRegister - (numRings * numVoterPerRing);
        
        for(var i = 0; i < offset; i++) {

            var x = contract.ring.call(numRings, i*2);
            var y = contract.ring.call(numRings, (i*2) + 1);

            assert(x.toString() == pubKeys[count][0].toString(), 'Public keys should match');
            assert(y.toString() == pubKeys[count][1].toString(), 'Public keys should match');
            count += 1;
        }
    }

    // Try to regiser an existing public key.
    assert(contract.registerVoter.call(pubKeys[0]) == false, 'Cannot register key twice');

}

var instance = deploySmartContractTest(testRegiserVoters);
